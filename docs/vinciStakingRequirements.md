# VINCI Staking - Requirements

The following requirements were specified by the vinci Product team. 

Naming (just a heads-up, that these names are used interchangeably):
- `claimable == vested`
- `unclaimable == unvested`

### Staking

- A user should be able to stake at any time any amount of Vinci tokens they own in their wallets
- The Vinci team must be able to stake tokens in behalf of holders, but never unstake them
- Staking must be possible regardless if the contract has funding for staking rewards or not (although, without funds,
  rewards are not guaranteed)

### Checkpoints

- A system of `staking periods` is initiated with the first staking of a user.
- These staking periods are separated by `checkpoints`
- The length of the first staking period is 6 months (180 days). The following staking periods decrease by 30 days each
  time, until reaching a minimum of 30 days. So the staking periods are 180, 150, 120, 90, 60, 30 days, and then 30 days
  always after that.
- The checkpoint system controls when rewards are vested. Any rewards generated by a user during a staking period is
  allocated as Unvested rewards. They become vested when the next checkpoint is crossed.
- The staking period of a user is independent of other users.
- The first time that a user crosses a checkpoint, it earns the status of Superstaker
- If a user fully unstakes everything, the staking period is reset and the user starts again with a 6 months staking
  period. Also the Superstaker status is lost.
- The rewards that are vested when crossing a period should remain vested when crossing following periods, obviously.

### Funds for staking rewards

- The contract is funded with VINCI tokens that are used to pay staking rewards to stakers
- Only certain Vinci wallets are allowed to fund the contract with VINCI tokens for rewards. These are the only wallets allowed to withdraw non-allocated rewards funds.
- Tokens that are deposited in the contract for staking rewards cannot be retrieved ever again if they have been allocated as rewards to any user
- Non-allocated funds can be retrieved by the wallet with the proper role (CONTRACT_FUNDER_ROLE)
- If the contract runs out of funds for staking rewards, it is accepted that the users might not be able to claim those
  rewards.
- The team should be able to track the missed rewards, to airdrop them at a later stage if possible

### Staking rewards

There are three sources of staking rewards:

- Base APR
- Airdrops
- Penalty pot

The frontend should be capable of distinguishing from where the unvested rewards come from, and how much of each type of
rewards. This tracking is not necessary once the rewards become vested. All sources accumulate rewards as unvested,
and become vested when the next checkpoint is crossed.

#### Rewards from base APR

- Staked tokens generate (unvested) rewards from the moment they are staked. These rewards remain unvested until the
  next checkpoint is crossed.
- The base APR is fixed to 5.5%, and the rewards are distributed in VINCI tokens.

#### Rewards from Airdrops

- The team can airdrop rewards to selected users
- These airdropped rewards are also allocated to the unvested rewards of the user, and become vested when the next
  checkpoint is crossed

#### Rewards from penalty Pot

- When a user unstakes, they are penalized with a percentage of their unvested rewards (deeper explanation in following
  section). This penalty is added to a `penalty pot`.
- The Vinci team can choose when to distribute the penalty pot among the remaning stakers. However, only the ones with
  the Superstaker status will receive a share of the penalty pot. The distribution is proportional to the amount of
  Vinci tokens staked by each Superstaker.
- The `penalty pot` is distributed among all remaining stakers that have the status of Superstaker (to their unvested
  rewards balance)

### Unstaking

- A user should be able to unstake any amount of their staked Vinci tokens at any time, however, tokens are locked for a
  period of 14 days before they can be withdrawn to a wallet.
- When a user unstakes, a penalty is imposed to all unclaimable (unvested) rewards, proportional to the amount of Vinci
  tokens that are unstaked compared to the user's total stake.
- Only the unvested rewards are penalized, the vested rewards are safe and already allocated to the user.
- When a user unstakes and is penalized, the penalty is added to a penalty pot, which is later distributed among all
  remaining superstakers.
- Unstaking must be possible regardless if the contract has funding for staking rewards or not
- If a user unstakes 100% of their staking balance the user is "finalized", which means that tiers, checkpoins and
  superstaker status are reset.
  However, user should still be able to claim vested tokens if any (which were earned by crossing a previous
  checkpoint).
- The unstaking penalty applies to all rewards from different sources: from APR, from airdrops or from penalty pot.

### Withdrawal

- When a user unstakes, the tokens are locked for 14 days before they can be withdrawn.
- Howerver, if a user unstakes again before withdrawing a pending unstake, the 14 days lock is reset and the amount is
  added, which means that both amounts will only be withdrawable 14 days after the second unstake

### Airdrops

- The vinci team should be able to airdrop extra rewards (VINCI tokens only) to selected users
- Only addresses with a positive staking balance in the contract can receive airdrops
- The airdropped tokens count as unvested rewards, so they are also subject to penalization when unstaking, and they
  become vested when the next checkpoint is crossed
- The airdropped VINCI tokens come from the wallet executing the airdrops.

### Claiming

- When a user crosses a checkpoint, all their unvested rewards become vested, and therefore claimable.
- A user should be able to claim their vested rewards at any time, but they can only claim the rewards that are
  claimable at the time of the claim.
- The rewards are directly sent to the user's wallet.
- Claiming must be possible regardless if the contract has funding for staking rewards or not

### Tiers

- A tier system is in place to grant extra benefits to top stakers.
- The tier thresholds are constant in **dollar** value.
- The contract only tracks the tier of each staker, but there are no further implications of having a tier from the
  contract point of view
- All tier-related benefits will be calculated offchain, and will be given in the form of airdrops or others (free
  tickets to events, etc)
- A tier is granted to a user at the moment of their first stake, and it is only reevaluated in the following scenarios:
    - When the next checkpoint is crossed
    - When the user executes a 'relock' operation
    - When the user unstakes a large enough amount, so that the new staking balance is **below** the threshold of the
      current tier (note that with this mechanism, tiers can only be downgraded, but nerver upgraded).
- The Vinci team has the power to change the thresholds of the different tiers at will. (Read known vulnerabilities in 
- the [contract implementation document](./vinciStakingImplementation.md)).

### Relock

- A staker can decide to `relock` their tokens at any time
- Only current stakers can `relock` their tokens
- Relocking has the following implications:
    - The staking period is reset, which means that it starts again from the relocking time, and has the same duration (
      no reducion in the staking period).
    - The tier is reevaluated, which means that it can be both downgraded or upgraded depending on the staking balance
      and tier thresholds at the moment of relocking.

### Superstaker status

- A user can become a Superstaker by crossing at least one checkpoint with a non-zero staking balance
- A user looses the status of Superstaker if they unstake all their tokens (and also the checkpoint system is reset)

### View functions

A number of view functions are implemented for the only purpose of showing certain infromation in the frontend. 
The frontend needs to be able to display the following information:
- Staking balance of each user
- Unstaking balance
- Release time of the unstaking tokens
- Unvested rewards, and the source from where they come (base APR, airdrops or penalty pot)
- Vested rewards, regardless of the source where they came from
- Next checkpoint of a user
- Length of the current staking period
- For how long a user has been a staker (since the first time they staked) without any 'user finalization' interruption in between
- Total vinci tokens staked in the contract

The tech team is aware that some of the storage variables of the contract are exclusively used for tracking variables 
that are only used for frontend display purposes. From a gas perspective this is really not ideal, but the alternative 
requires heavy loading times in the frontend or an extra backend, which the team decided not to have. Moreover, the 
contract will be deployed in a low-gas fee network such as polygon or bnb, so we can afford small inefficiencies.
